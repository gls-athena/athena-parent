# Pull Request æŒç»­é›†æˆå·¥ä½œæµ
name: CI - Pull Request

on:
  pull_request:
    branches: [ develop, master ]
    types: [ opened, synchronize, reopened ]

permissions:
  contents: read
  pull-requests: write
  checks: write
  actions: read

env:
  MAVEN_OPTS: "-Xmx2048m"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

jobs:
  # å˜æ›´æ£€æµ‹
  changes:
    runs-on: ubuntu-latest
    outputs:
      java: ${{ steps.changes.outputs.java }}
      docs: ${{ steps.changes.outputs.docs }}
      config: ${{ steps.changes.outputs.config }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            java:
              - '**/*.java'
              - '**/pom.xml'
              - '**/*.properties'
              - '**/*.yml'
              - '**/*.yaml'
            docs:
              - '**/*.md'
              - 'docs/**'
            config:
              - '.github/**'
              - '**/pom.xml'

  # å¿«é€ŸéªŒè¯
  quick-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: changes
    if: needs.changes.outputs.java == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Extract version
        id: extract_version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=revision -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Validate and compile
        run: |
          mvn ${{ env.MAVEN_CLI_OPTS }} validate -Drevision=${{ steps.extract_version.outputs.version }}
          mvn ${{ env.MAVEN_CLI_OPTS }} clean compile -Drevision=${{ steps.extract_version.outputs.version }}

  # å®Œæ•´æµ‹è¯•
  test:
    runs-on: ubuntu-latest
    needs: [ changes, quick-check ]
    if: needs.changes.outputs.java == 'true'
    timeout-minutes: 25

    strategy:
      matrix:
        test-type: [ unit, integration ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Extract version
        id: extract_version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=revision -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Run unit tests
        if: matrix.test-type == 'unit'
        run: mvn ${{ env.MAVEN_CLI_OPTS }} test -Drevision=${{ steps.extract_version.outputs.version }}

      - name: Run integration tests
        if: matrix.test-type == 'integration'
        run: mvn ${{ env.MAVEN_CLI_OPTS }} verify -DskipUnitTests=true -Drevision=${{ steps.extract_version.outputs.version }}

      - name: Generate test reports
        if: always()
        uses: dorny/test-reporter@v1.9.1
        with:
          name: ${{ matrix.test-type }} Tests
          path: '**/target/surefire-reports/*.xml,**/target/failsafe-reports/*.xml'
          reporter: java-junit
          fail-on-error: false

  # ä»£ç è´¨é‡åˆ†æ
  quality-gate:
    runs-on: ubuntu-latest
    needs: [ changes, quick-check ]
    if: needs.changes.outputs.java == 'true'
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Extract version
        id: extract_version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=revision -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Code quality checks
        run: |
          mvn ${{ env.MAVEN_CLI_OPTS }} compile -Drevision=${{ steps.extract_version.outputs.version }}
          mvn ${{ env.MAVEN_CLI_OPTS }} checkstyle:check -Drevision=${{ steps.extract_version.outputs.version }} || true
          mvn ${{ env.MAVEN_CLI_OPTS }} spotbugs:check -Drevision=${{ steps.extract_version.outputs.version }} || true

      - name: SonarQube Scan
        if: github.event.pull_request.head.repo.full_name == github.repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn ${{ env.MAVEN_CLI_OPTS }} verify sonar:sonar \
            -Dsonar.projectKey=athena-parent \
            -Dsonar.organization=gls-athena \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.pullrequest.key=${{ github.event.number }} \
            -Dsonar.pullrequest.branch=${{ github.head_ref }} \
            -Dsonar.pullrequest.base=${{ github.base_ref }} \
            -Drevision=${{ steps.extract_version.outputs.version }}

  # å®‰å…¨æ£€æŸ¥
  security-check:
    runs-on: ubuntu-latest
    needs: [ changes, quick-check ]
    if: needs.changes.outputs.java == 'true'
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Extract version
        id: extract_version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=revision -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: OWASP Dependency Check
        run: mvn ${{ env.MAVEN_CLI_OPTS }} org.owasp:dependency-check-maven:check -Drevision=${{ steps.extract_version.outputs.version }}
        continue-on-error: true

      - name: Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  # æ„å»ºéªŒè¯
  build-check:
    runs-on: ubuntu-latest
    needs: [ test, quality-gate, security-check ]
    if: needs.changes.outputs.java == 'true'
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Extract version
        id: extract_version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=revision -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build without tests
        run: mvn ${{ env.MAVEN_CLI_OPTS }} clean package -DskipTests -Drevision=${{ steps.extract_version.outputs.version }}

      - name: Verify build artifacts
        run: |
          find . -name "*.jar" -path "*/target/*" -not -path "*-sources.jar" -not -path "*-javadoc.jar" | head -10

  # PR æ‘˜è¦æŠ¥å‘Š
  pr-summary:
    runs-on: ubuntu-latest
    needs: [ changes, quick-check, test, quality-gate, security-check, build-check ]
    if: always()

    steps:
      - name: Generate PR Summary
        uses: actions/github-script@v7
        with:
          script: |
            const needs = ${{ toJSON(needs) }};
            
            let summary = "## ğŸ” Pull Request éªŒè¯æ‘˜è¦\n\n";
            
            if (needs.changes.outputs.java === 'true') {
              summary += "### ğŸ“Š æ£€æŸ¥ç»“æœ\n\n";
              summary += "| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯¦æƒ… |\n";
              summary += "|--------|------|------|\n";
              summary += `| å¿«é€ŸéªŒè¯ | ${needs['quick-check'].result === 'success' ? 'âœ…' : 'âŒ'} | ç¼–è¯‘å’ŒåŸºæœ¬éªŒè¯ |\n`;
              summary += `| å•å…ƒæµ‹è¯• | ${needs.test.result === 'success' ? 'âœ…' : 'âŒ'} | æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ |\n`;
              summary += `| ä»£ç è´¨é‡ | ${needs['quality-gate'].result === 'success' ? 'âœ…' : 'âŒ'} | é™æ€åˆ†æå’Œä»£ç è§„èŒƒ |\n`;
              summary += `| å®‰å…¨æ£€æŸ¥ | ${needs['security-check'].result === 'success' ? 'âœ…' : 'âŒ'} | ä¾èµ–æ¼æ´æ‰«æ |\n`;
              summary += `| æ„å»ºéªŒè¯ | ${needs['build-check'].result === 'success' ? 'âœ…' : 'âŒ'} | æ‰“åŒ…å’Œæ„å»º |\n`;
            } else {
              summary += "### ğŸ“ æ–‡æ¡£å˜æ›´\n\n";
              summary += "æ­¤ PR ä¸»è¦åŒ…å«æ–‡æ¡£æˆ–é…ç½®å˜æ›´ï¼Œè·³è¿‡äº† Java ä»£ç ç›¸å…³æ£€æŸ¥ã€‚\n";
            }
            
            summary += "\n### ğŸ“‹ å˜æ›´æ£€æµ‹\n\n";
            summary += `- Java ä»£ç : ${needs.changes.outputs.java === 'true' ? 'æ˜¯' : 'å¦'}\n`;
            summary += `- æ–‡æ¡£: ${needs.changes.outputs.docs === 'true' ? 'æ˜¯' : 'å¦'}\n`;
            summary += `- é…ç½®: ${needs.changes.outputs.config === 'true' ? 'æ˜¯' : 'å¦'}\n`;
            
            return summary;
          result-encoding: string

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `${{ steps.pr-summary.outputs.result }}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
