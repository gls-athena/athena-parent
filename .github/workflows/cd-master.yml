# å·¥ä½œæµåç§°ï¼šCD - Master Branch Release
# åŠŸèƒ½æè¿°ï¼šå½“ master åˆ†æ”¯æœ‰æ¨é€æˆ–æ‰‹åŠ¨è§¦å‘æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œç‰ˆæœ¬å‘å¸ƒæµç¨‹

name: CD - Master Branch Release

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version increment type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

# æƒé™é…ç½®
permissions:
  contents: write
  packages: write

# å®šä¹‰å·¥ä½œæµä¸­çš„ä½œä¸š
jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # è®¾ç½® JDK ç¯å¢ƒ
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # è®¾ç½® GPG å¯†é’¥ï¼ˆå¦‚æœéœ€è¦ç­¾åï¼‰
      - name: Set up GPG
        if: ${{ secrets.GPG_PRIVATE_KEY != '' }}
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          gpg --list-secret-keys --keyid-format LONG

      # è®¡ç®—ç‰ˆæœ¬å·
      - name: Calculate release version
        id: version
        run: |
          CURRENT_VERSION=$(mvn help:evaluate -Dexpression=revision -q -DforceStdout | sed 's/-SNAPSHOT//')
          VERSION_TYPE="${{ github.event.inputs.version_type || 'patch' }}"
          
          # å½“å‰ç‰ˆæœ¬å°±æ˜¯è¦å‘å¸ƒçš„ç‰ˆæœ¬
          RELEASE_VERSION="$CURRENT_VERSION"
          
          # è®¡ç®—ä¸‹ä¸€ä¸ªå¼€å‘ç‰ˆæœ¬
          IFS='.' read -ra VERSION_PARTS <<< "$RELEASE_VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          
          case $VERSION_TYPE in
            "major")
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            "minor")
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            "patch")
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEXT_VERSION="$MAJOR.$MINOR.$PATCH-SNAPSHOT"
          
          echo "release=$RELEASE_VERSION" >> $GITHUB_OUTPUT
          echo "next=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $RELEASE_VERSION"
          echo "Next development version: $NEXT_VERSION"

      # ç”Ÿæˆ Release Notes
      - name: Generate release notes
        id: release_notes
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -n "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log ${PREVIOUS_TAG}..HEAD --oneline --no-merges --format="- %s (%h)" | head -20)
          else
            COMMITS=$(git log HEAD --oneline --no-merges --format="- %s (%h)" | head -10)
          fi
          
          {
            echo 'commits<<EOF'
            echo "$COMMITS"
            echo 'EOF'
          } >> $GITHUB_OUTPUT
          
          echo "previous_tag=${PREVIOUS_TAG:-'Initial release'}" >> $GITHUB_OUTPUT

      # è¿è¡Œæµ‹è¯•
      - name: Run tests
        run: mvn clean test -Drevision=${{ steps.version.outputs.release }}

      # å‘å¸ƒç‰ˆæœ¬ï¼šæ›´æ–°ç‰ˆæœ¬ã€æ„å»ºã€åˆ›å»ºæ ‡ç­¾
      - name: Release version
        run: |
          # æ›´æ–°ä¸ºå‘å¸ƒç‰ˆæœ¬
          sed -i "s/<revision>.*<\/revision>/<revision>${{ steps.version.outputs.release }}<\/revision>/g" pom.xml
          
          # æ„å»ºé¡¹ç›®
          mvn clean package -DskipTests -Drevision=${{ steps.version.outputs.release }}
          
          # æäº¤å‘å¸ƒç‰ˆæœ¬
          git add .
          git commit -m "Release version ${{ steps.version.outputs.release }}" || echo "No changes to commit"
          
          # åˆ›å»ºæ ‡ç­¾
          git tag -a "v${{ steps.version.outputs.release }}" -m "Release version ${{ steps.version.outputs.release }}"

      # éƒ¨ç½²åˆ° Maven ä»“åº“ï¼ˆæ”¯æŒ SNAPSHOT å’Œ Releaseï¼‰
      - name: Deploy to Maven Repository
        env:
          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          GPG_KEYNAME: ${{ secrets.GPG_KEYNAME }}
          GITHUB_USERNAME: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ steps.version.outputs.release }}" == *"SNAPSHOT"* ]]; then
            echo "ğŸ“¦ Deploying SNAPSHOT version to OSSRH..."
            mvn deploy -DskipTests -Drevision=${{ steps.version.outputs.release }} \
              --settings .github/settings.xml \
              -Possrh
          else
            echo "ğŸ“¦ Deploying RELEASE version to Maven Central..."
            mvn deploy -DskipTests -Drevision=${{ steps.version.outputs.release }} \
              --settings .github/settings.xml \
              -Prelease,ossrh
          fi

      # å‡†å¤‡ä¸‹ä¸€ä¸ªå¼€å‘ç‰ˆæœ¬
      - name: Prepare next development version
        run: |
          # æ›´æ–°ä¸ºä¸‹ä¸€ä¸ªå¼€å‘ç‰ˆæœ¬
          sed -i "s/<revision>.*<\/revision>/<revision>${{ steps.version.outputs.next }}<\/revision>/g" pom.xml
          
          # æäº¤ä¸‹ä¸€ä¸ªå¼€å‘ç‰ˆæœ¬
          git add .
          git commit -m "Prepare for next development iteration ${{ steps.version.outputs.next }}" || echo "No changes to commit"

      # æ¨é€å˜æ›´
      - name: Push changes
        run: |
          git push origin master
          git push origin "v${{ steps.version.outputs.release }}"

      # åŒæ­¥åˆ° develop åˆ†æ”¯
      - name: Sync to develop branch
        run: |
          if git show-ref --verify --quiet refs/remotes/origin/develop; then
            git checkout develop
            git pull origin develop
            git merge master --no-ff -m "Sync release v${{ steps.version.outputs.release }} changes to develop"
            git push origin develop
            echo "âœ… Successfully synced changes to develop branch"
          else
            echo "âš ï¸ Develop branch does not exist, skipping sync"
          fi

      # åˆ›å»º GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.version.outputs.release }}"
          name: "Release v${{ steps.version.outputs.release }}"
          body: |
            ## Release Notes for v${{ steps.version.outputs.release }}
            
            **Release Type:** ${{ github.event.inputs.version_type || 'patch' }} version increment
            **Previous Version:** ${{ steps.release_notes.outputs.previous_tag }}
            
            ### ğŸš€ What's Changed
            ${{ steps.release_notes.outputs.commits }}
            
            ### ğŸ“¦ Installation
            
            ```xml
            <dependency>
                <groupId>io.github.gls-athena</groupId>
                <artifactId>athena-parent</artifactId>
                <version>${{ steps.version.outputs.release }}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            ```
            
            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.release_notes.outputs.previous_tag }}...v${{ steps.version.outputs.release }}
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      # å‘å¸ƒç»“æœé€šçŸ¥
      - name: Notify result
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Release v${{ steps.version.outputs.release }} completed successfully!"
            echo "ğŸ“¦ Artifacts deployed to Maven Central"
            echo "ğŸ·ï¸ Git tag v${{ steps.version.outputs.release }} created"
            echo "ğŸ“‹ GitHub Release created"
          else
            echo "âŒ Release failed! Please check the logs and fix any issues."
            echo "ğŸ” Common issues:"
            echo "  - Missing OSSRH credentials (OSSRH_USERNAME, OSSRH_PASSWORD)"
            echo "  - Missing GPG configuration (GPG_PRIVATE_KEY, GPG_PASSPHRASE)"
            echo "  - Network connectivity issues"
          fi
