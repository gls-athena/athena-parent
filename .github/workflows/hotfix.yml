# çƒ­ä¿®å¤å·¥ä½œæµ
name: Hotfix Release

on:
  push:
    branches: [ 'hotfix/**' ]
  workflow_dispatch:
    inputs:
      hotfix_version:
        description: 'çƒ­ä¿®å¤ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.1)'
        required: true
        type: string
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯'
        required: true
        default: 'master'
        type: choice
        options:
          - master
          - develop

permissions:
  contents: write
  packages: write
  pull-requests: write
  issues: write

env:
  MAVEN_OPTS: "-Xmx2048m"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

jobs:
  # çƒ­ä¿®å¤éªŒè¯
  hotfix-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      hotfix-version: ${{ steps.version.outputs.hotfix-version }}
      base-version: ${{ steps.version.outputs.base-version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Extract version information
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            HOTFIX_VERSION="${{ github.event.inputs.hotfix_version }}"
          else
            # ä»åˆ†æ”¯åæå–ç‰ˆæœ¬ (hotfix/1.0.1 -> 1.0.1)
            BRANCH_NAME="${{ github.ref_name }}"
            HOTFIX_VERSION=${BRANCH_NAME#hotfix/}
          fi
          
          BASE_VERSION=$(mvn help:evaluate -Dexpression=revision -q -DforceStdout | sed 's/-SNAPSHOT//')
          
          echo "hotfix-version=$HOTFIX_VERSION" >> $GITHUB_OUTPUT
          echo "base-version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "Hotfix version: $HOTFIX_VERSION"
          echo "Base version: $BASE_VERSION"

      - name: Validate hotfix version
        run: |
          HOTFIX_VERSION="${{ steps.version.outputs.hotfix-version }}"
          if ! [[ $HOTFIX_VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Invalid version format. Expected format: x.y.z"
            exit 1
          fi
          
          if git tag | grep -q "^v$HOTFIX_VERSION$"; then
            echo "Error: Version $HOTFIX_VERSION already exists"
            exit 1
          fi

      - name: Update version for hotfix
        run: |
          mvn versions:set -DnewVersion=${{ steps.version.outputs.hotfix-version }}
          mvn versions:commit

      - name: Run critical tests
        run: |
          mvn ${{ env.MAVEN_CLI_OPTS }} clean test -Drevision=${{ steps.version.outputs.hotfix-version }}

      - name: Build hotfix
        run: |
          mvn ${{ env.MAVEN_CLI_OPTS }} clean package -DskipTests -Drevision=${{ steps.version.outputs.hotfix-version }}

  # å®‰å…¨æ£€æŸ¥
  security-check:
    runs-on: ubuntu-latest
    needs: hotfix-validation
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: OWASP Dependency Check
        run: |
          mvn ${{ env.MAVEN_CLI_OPTS }} org.owasp:dependency-check-maven:check \
            -Drevision=${{ needs.hotfix-validation.outputs.hotfix-version }}
        continue-on-error: true

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hotfix-security-report
          path: '**/target/dependency-check-report.html'

  # çƒ­ä¿®å¤å‘å¸ƒ
  hotfix-release:
    runs-on: ubuntu-latest
    needs: [ hotfix-validation, security-check ]
    if: needs.security-check.result == 'success'
    timeout-minutes: 25

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Configure GPG
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          echo "use-agent" >> ~/.gnupg/gpg.conf
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf

      - name: Configure Maven settings
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE

      - name: Update version
        run: |
          mvn versions:set -DnewVersion=${{ needs.hotfix-validation.outputs.hotfix-version }}
          mvn versions:commit

      - name: Build and deploy hotfix
        env:
          MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSSRH_TOKEN }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          mvn ${{ env.MAVEN_CLI_OPTS }} clean deploy -P release -DskipTests \
            -Drevision=${{ needs.hotfix-validation.outputs.hotfix-version }}

      - name: Create and push hotfix tag
        run: |
          HOTFIX_VERSION="${{ needs.hotfix-validation.outputs.hotfix-version }}"
          git add .
          git commit -m "hotfix: release version $HOTFIX_VERSION"
          git tag -a "v$HOTFIX_VERSION" -m "Hotfix release $HOTFIX_VERSION"
          git push origin "v$HOTFIX_VERSION"

      - name: Generate hotfix changelog
        id: changelog
        run: |
          HOTFIX_VERSION="${{ needs.hotfix-validation.outputs.hotfix-version }}"
          BASE_VERSION="${{ needs.hotfix-validation.outputs.base-version }}"
          
          # æŸ¥æ‰¾ä¸Šä¸€ä¸ªç‰ˆæœ¬æ ‡ç­¾
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "v$BASE_VERSION")
          
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" $LAST_TAG..HEAD)
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.hotfix-validation.outputs.hotfix-version }}
          release_name: Hotfix v${{ needs.hotfix-validation.outputs.hotfix-version }}
          body: |
            ## ğŸ”¥ Hotfix Release v${{ needs.hotfix-validation.outputs.hotfix-version }}
            
            ### âš¡ ç´§æ€¥ä¿®å¤
            æ­¤ç‰ˆæœ¬åŒ…å«é‡è¦çš„é—®é¢˜ä¿®å¤ï¼Œå»ºè®®ç«‹å³å‡çº§ã€‚
            
            ### ğŸ“‹ ä¿®å¤å†…å®¹
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            ### ğŸ“¦ Maven åæ ‡
            ```xml
            <dependency>
                <groupId>io.github.gls-athena</groupId>
                <artifactId>athena-parent</artifactId>
                <version>${{ needs.hotfix-validation.outputs.hotfix-version }}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            ```
            
            ### ğŸ”— ç›¸å…³é“¾æ¥
            - [Maven Central](https://search.maven.org/artifact/io.github.gls-athena/athena-parent/${{ needs.hotfix-validation.outputs.hotfix-version }}/pom)
            - [é—®é¢˜è¿½è¸ª](https://github.com/gls-athena/athena-parent/issues)
          draft: false
          prerelease: false

  # åˆå¹¶å›ä¸»åˆ†æ”¯
  merge-back:
    runs-on: ubuntu-latest
    needs: [ hotfix-validation, hotfix-release ]
    if: needs.hotfix-release.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge hotfix to master
        run: |
          git checkout master
          git pull origin master
          git merge ${{ github.ref_name }} --no-edit
          git push origin master

      - name: Merge hotfix to develop
        run: |
          git checkout develop
          git pull origin develop
          git merge master --no-edit
          git push origin develop
        continue-on-error: true

      - name: Create PR if merge conflicts
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const hotfixVersion = '${{ needs.hotfix-validation.outputs.hotfix-version }}';
            
            await github.rest.pulls.create({
              owner,
              repo,
              title: `Merge hotfix v${hotfixVersion} to develop`,
              head: 'master',
              base: 'develop',
              body: `## ğŸ”„ è‡ªåŠ¨åˆå¹¶çƒ­ä¿®å¤
            
              çƒ­ä¿®å¤ v${hotfixVersion} å·²å‘å¸ƒåˆ° master åˆ†æ”¯ï¼Œä½†è‡ªåŠ¨åˆå¹¶åˆ° develop åˆ†æ”¯æ—¶é‡åˆ°å†²çªã€‚
            
              è¯·æ‰‹åŠ¨è§£å†³å†²çªå¹¶åˆå¹¶æ­¤ PRã€‚
            
              ### ğŸ“‹ çƒ­ä¿®å¤å†…å®¹
              - ç‰ˆæœ¬: v${hotfixVersion}
              - åˆ†æ”¯: ${context.ref}
            
              ### âš ï¸ æ³¨æ„äº‹é¡¹
              è¯·ç¡®ä¿æ‰€æœ‰å†²çªéƒ½å·²æ­£ç¡®è§£å†³ï¼Œå¹¶ä¸”ä¸ä¼šå½±å“ develop åˆ†æ”¯çš„å¼€å‘è¿›åº¦ã€‚`,
              draft: false
            });

      - name: Clean up hotfix branch
        if: success()
        run: |
          git push origin --delete ${{ github.ref_name }}

  # é€šçŸ¥
  notification:
    runs-on: ubuntu-latest
    needs: [ hotfix-validation, hotfix-release, merge-back ]
    if: always()

    steps:
      - name: Create workflow summary
        run: |
          echo "## ğŸ”¥ çƒ­ä¿®å¤å·¥ä½œæµæ‰§è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ çƒ­ä¿®å¤ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: v${{ needs.hotfix-validation.outputs.hotfix-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åŸºç¡€ç‰ˆæœ¬**: v${{ needs.hotfix-validation.outputs.base-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å‘å¸ƒæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š æ‰§è¡Œç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "| ä»»åŠ¡ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| çƒ­ä¿®å¤éªŒè¯ | ${{ needs.hotfix-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| çƒ­ä¿®å¤å‘å¸ƒ | ${{ needs.hotfix-release.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| åˆ†æ”¯åˆå¹¶ | ${{ needs.merge-back.result }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.hotfix-release.result }}" = "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ‰ å‘å¸ƒæˆåŠŸ!" >> $GITHUB_STEP_SUMMARY
            echo "- [GitHub Release](https://github.com/gls-athena/athena-parent/releases/tag/v${{ needs.hotfix-validation.outputs.hotfix-version }})" >> $GITHUB_STEP_SUMMARY
            echo "- [Maven Central](https://search.maven.org/artifact/io.github.gls-athena/athena-parent/${{ needs.hotfix-validation.outputs.hotfix-version }}/pom)" >> $GITHUB_STEP_SUMMARY
          fi
