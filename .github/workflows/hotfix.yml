# Hotfix Release 工作流
# 用于创建并发布一个热修复版本，包括分支创建、版本更新、测试、打包、标签推送、GitHub Release 创建、合并回主分支的 PR 以及部署到 Maven 仓库。
#
# 触发方式：
#   手动触发（workflow_dispatch）
#
# 输入参数说明：
#   hotfix_version: 热修复版本号（如：1.0.1），必填
#   base_branch: 基础分支，用于创建 hotfix 分支，可选 master 或 develop，默认为 master
#   description: 热修复描述信息，必填

name: Hotfix Release

on:
  workflow_dispatch:
    inputs:
      hotfix_version:
        description: 'Hotfix version (e.g., 1.0.1)'
        required: true
        type: string
      base_branch:
        description: 'Base branch for hotfix'
        required: true
        default: 'master'
        type: choice
        options:
          - master
          - develop
      description:
        description: 'Hotfix description'
        required: true
        type: string

jobs:
  hotfix:
    runs-on: ubuntu-latest

    steps:
      # 检出代码，并切换到指定的基础分支
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: ${{ github.event.inputs.base_branch }}

      # 设置 JDK 21 环境，并启用 Maven 缓存
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      # 配置 Git 用户信息，用于后续提交操作
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # 创建 hotfix 分支并保存分支名到环境变量中
      - name: Create hotfix branch
        run: |
          HOTFIX_BRANCH="hotfix/${{ github.event.inputs.hotfix_version }}"
          git checkout -b $HOTFIX_BRANCH
          echo "hotfix_branch=$HOTFIX_BRANCH" >> $GITHUB_ENV

      # 更新项目版本号为热修复版本号
      - name: Update version to hotfix version
        run: |
          mvn versions:set -DnewVersion=${{ github.event.inputs.hotfix_version }} -DgenerateBackupPoms=false
          mvn versions:update-child-modules -DgenerateBackupPoms=false

      # 运行单元测试以验证热修复内容
      - name: Run tests
        run: |
          mvn clean test -Drevision=${{ github.event.inputs.hotfix_version }}

      # 构建并打包项目（跳过测试）
      - name: Build and package
        run: |
          mvn clean package -DskipTests -Drevision=${{ github.event.inputs.hotfix_version }}

      # 提交热修复更改到当前分支
      - name: Commit hotfix changes
        run: |
          git add .
          git commit -m "Hotfix: ${{ github.event.inputs.description }} - v${{ github.event.inputs.hotfix_version }}"

      # 为热修复版本创建 Git 标签
      - name: Create hotfix tag
        run: |
          git tag -a "v${{ github.event.inputs.hotfix_version }}" -m "Hotfix release v${{ github.event.inputs.hotfix_version }}: ${{ github.event.inputs.description }}"

      # 推送 hotfix 分支和标签到远程仓库
      - name: Push hotfix branch and tag
        run: |
          git push origin ${{ env.hotfix_branch }}
          git push origin "v${{ github.event.inputs.hotfix_version }}"

      # 创建 GitHub Release，包含版本说明和安装方式
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "v${{ github.event.inputs.hotfix_version }}"
          release_name: "Hotfix v${{ github.event.inputs.hotfix_version }}"
          body: |
            ## 🚨 Hotfix Release v${{ github.event.inputs.hotfix_version }}
            
            ### Description
            ${{ github.event.inputs.description }}
            
            ### Base Branch
            Based on: `${{ github.event.inputs.base_branch }}`
            
            ### Changes
            This is a hotfix release addressing critical issues.
            
            ### Installation
            
            ```xml
            <dependency>
                <groupId>io.github.gls-athena</groupId>
                <artifactId>athena-parent</artifactId>
                <version>${{ github.event.inputs.hotfix_version }}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            ```
          draft: false
          prerelease: false

      # 创建 Pull Request，将 hotfix 分支合并回基础分支
      - name: Create Pull Request to merge back
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequest } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Merge hotfix v${{ github.event.inputs.hotfix_version }} back to ${{ github.event.inputs.base_branch }}`,
              head: '${{ env.hotfix_branch }}',
              base: '${{ github.event.inputs.base_branch }}',
              body: `
              ## Hotfix Merge Back
            
              This PR merges the hotfix v${{ github.event.inputs.hotfix_version }} back to the ${{ github.event.inputs.base_branch }} branch.
            
              ### Hotfix Details
              - **Version**: v${{ github.event.inputs.hotfix_version }}
              - **Description**: ${{ github.event.inputs.description }}
              - **Base Branch**: ${{ github.event.inputs.base_branch }}
            
              Please review and merge to complete the hotfix process.
              `
            });
            
            console.log(\`Created PR #\${pullRequest.number}\`);

      # 部署热修复版本到 Maven 仓库（如果配置了认证信息）
      - name: Deploy hotfix to Maven Repository
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
        run: |
          if [ -n "$MAVEN_USERNAME" ] && [ -n "$MAVEN_PASSWORD" ]; then
            mvn deploy -DskipTests -Drevision=${{ github.event.inputs.hotfix_version }} \
              -s .github/settings.xml \
              -Dmaven.repo.username=$MAVEN_USERNAME \
              -Dmaven.repo.password=$MAVEN_PASSWORD
          else
            echo "Maven deployment skipped - credentials not configured"
          fi
