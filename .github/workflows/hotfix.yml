# Hotfix Release å·¥ä½œæµ
# ç”¨äºåˆ›å»ºå¹¶å‘å¸ƒä¸€ä¸ªçƒ­ä¿®å¤ç‰ˆæœ¬ï¼ŒåŒ…æ‹¬åˆ†æ”¯åˆ›å»ºã€ç‰ˆæœ¬æ›´æ–°ã€æµ‹è¯•ã€æ‰“åŒ…ã€æ ‡ç­¾æ¨é€ã€GitHub Release åˆ›å»ºã€åˆå¹¶å›ä¸»åˆ†æ”¯çš„ PR ä»¥åŠéƒ¨ç½²åˆ° Maven ä»“åº“ã€‚
#
# è§¦å‘æ–¹å¼ï¼š
#   æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰
#
# è¾“å…¥å‚æ•°è¯´æ˜ï¼š
#   hotfix_version: çƒ­ä¿®å¤ç‰ˆæœ¬å·ï¼ˆå¦‚ï¼š1.0.1ï¼‰ï¼Œå¿…å¡«
#   base_branch: åŸºç¡€åˆ†æ”¯ï¼Œç”¨äºåˆ›å»º hotfix åˆ†æ”¯ï¼Œå¯é€‰ master æˆ– developï¼Œé»˜è®¤ä¸º master
#   description: çƒ­ä¿®å¤æè¿°ä¿¡æ¯ï¼Œå¿…å¡«

name: Hotfix Release

on:
  workflow_dispatch:
    inputs:
      hotfix_version:
        description: 'Hotfix version (e.g., 1.0.1)'
        required: true
        type: string
      base_branch:
        description: 'Base branch for hotfix'
        required: true
        default: 'master'
        type: choice
        options:
          - master
          - develop
      description:
        description: 'Hotfix description'
        required: true
        type: string

jobs:
  hotfix:
    runs-on: ubuntu-latest

    steps:
      # æ£€å‡ºä»£ç ï¼Œå¹¶åˆ‡æ¢åˆ°æŒ‡å®šçš„åŸºç¡€åˆ†æ”¯
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: ${{ github.event.inputs.base_branch }}

      # è®¾ç½® JDK 21 ç¯å¢ƒï¼Œå¹¶å¯ç”¨ Maven ç¼“å­˜
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      # é…ç½® Git ç”¨æˆ·ä¿¡æ¯ï¼Œç”¨äºåç»­æäº¤æ“ä½œ
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # åˆ›å»º hotfix åˆ†æ”¯å¹¶ä¿å­˜åˆ†æ”¯ååˆ°ç¯å¢ƒå˜é‡ä¸­
      - name: Create hotfix branch
        run: |
          HOTFIX_BRANCH="hotfix/${{ github.event.inputs.hotfix_version }}"
          git checkout -b $HOTFIX_BRANCH
          echo "hotfix_branch=$HOTFIX_BRANCH" >> $GITHUB_ENV

      # æ›´æ–°é¡¹ç›®ç‰ˆæœ¬å·ä¸ºçƒ­ä¿®å¤ç‰ˆæœ¬å·
      - name: Update version to hotfix version
        run: |
          mvn versions:set -DnewVersion=${{ github.event.inputs.hotfix_version }} -DgenerateBackupPoms=false
          mvn versions:update-child-modules -DgenerateBackupPoms=false

      # è¿è¡Œå•å…ƒæµ‹è¯•ä»¥éªŒè¯çƒ­ä¿®å¤å†…å®¹
      - name: Run tests
        run: |
          mvn clean test -Drevision=${{ github.event.inputs.hotfix_version }}

      # æ„å»ºå¹¶æ‰“åŒ…é¡¹ç›®ï¼ˆè·³è¿‡æµ‹è¯•ï¼‰
      - name: Build and package
        run: |
          mvn clean package -DskipTests -Drevision=${{ github.event.inputs.hotfix_version }}

      # æäº¤çƒ­ä¿®å¤æ›´æ”¹åˆ°å½“å‰åˆ†æ”¯
      - name: Commit hotfix changes
        run: |
          git add .
          git commit -m "Hotfix: ${{ github.event.inputs.description }} - v${{ github.event.inputs.hotfix_version }}"

      # ä¸ºçƒ­ä¿®å¤ç‰ˆæœ¬åˆ›å»º Git æ ‡ç­¾
      - name: Create hotfix tag
        run: |
          git tag -a "v${{ github.event.inputs.hotfix_version }}" -m "Hotfix release v${{ github.event.inputs.hotfix_version }}: ${{ github.event.inputs.description }}"

      # æ¨é€ hotfix åˆ†æ”¯å’Œæ ‡ç­¾åˆ°è¿œç¨‹ä»“åº“
      - name: Push hotfix branch and tag
        run: |
          git push origin ${{ env.hotfix_branch }}
          git push origin "v${{ github.event.inputs.hotfix_version }}"

      # åˆ›å»º GitHub Releaseï¼ŒåŒ…å«ç‰ˆæœ¬è¯´æ˜å’Œå®‰è£…æ–¹å¼
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "v${{ github.event.inputs.hotfix_version }}"
          release_name: "Hotfix v${{ github.event.inputs.hotfix_version }}"
          body: |
            ## ğŸš¨ Hotfix Release v${{ github.event.inputs.hotfix_version }}
            
            ### Description
            ${{ github.event.inputs.description }}
            
            ### Base Branch
            Based on: `${{ github.event.inputs.base_branch }}`
            
            ### Changes
            This is a hotfix release addressing critical issues.
            
            ### Installation
            
            ```xml
            <dependency>
                <groupId>io.github.gls-athena</groupId>
                <artifactId>athena-parent</artifactId>
                <version>${{ github.event.inputs.hotfix_version }}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            ```
          draft: false
          prerelease: false

      # åˆ›å»º Pull Requestï¼Œå°† hotfix åˆ†æ”¯åˆå¹¶å›åŸºç¡€åˆ†æ”¯
      - name: Create Pull Request to merge back
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequest } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Merge hotfix v${{ github.event.inputs.hotfix_version }} back to ${{ github.event.inputs.base_branch }}`,
              head: '${{ env.hotfix_branch }}',
              base: '${{ github.event.inputs.base_branch }}',
              body: `
              ## Hotfix Merge Back
            
              This PR merges the hotfix v${{ github.event.inputs.hotfix_version }} back to the ${{ github.event.inputs.base_branch }} branch.
            
              ### Hotfix Details
              - **Version**: v${{ github.event.inputs.hotfix_version }}
              - **Description**: ${{ github.event.inputs.description }}
              - **Base Branch**: ${{ github.event.inputs.base_branch }}
            
              Please review and merge to complete the hotfix process.
              `
            });
            
            console.log(\`Created PR #\${pullRequest.number}\`);

      # éƒ¨ç½²çƒ­ä¿®å¤ç‰ˆæœ¬åˆ° Maven ä»“åº“ï¼ˆå¦‚æœé…ç½®äº†è®¤è¯ä¿¡æ¯ï¼‰
      - name: Deploy hotfix to Maven Repository
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
        run: |
          if [ -n "$MAVEN_USERNAME" ] && [ -n "$MAVEN_PASSWORD" ]; then
            mvn deploy -DskipTests -Drevision=${{ github.event.inputs.hotfix_version }} \
              -s .github/settings.xml \
              -Dmaven.repo.username=$MAVEN_USERNAME \
              -Dmaven.repo.password=$MAVEN_PASSWORD
          else
            echo "Maven deployment skipped - credentials not configured"
          fi
