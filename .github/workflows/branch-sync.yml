# åˆ†æ”¯åŒæ­¥å·¥ä½œæµ
name: Branch Sync

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 8:00 UTC (åŒ—äº¬æ—¶é—´ 16:00) æ‰§è¡ŒåŒæ­¥
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'æºåˆ†æ”¯'
        required: true
        default: 'master'
        type: choice
        options:
          - master
          - develop
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯'
        required: true
        default: 'develop'
        type: choice
        options:
          - develop
          - master
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥ï¼ˆå¿½ç•¥å†²çªè­¦å‘Šï¼‰'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # åˆ†æ”¯åŒæ­¥æ£€æŸ¥
  sync-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      needs-sync: ${{ steps.check.outputs.needs-sync }}
      source-branch: ${{ steps.branches.outputs.source }}
      target-branch: ${{ steps.branches.outputs.target }}
      commits-behind: ${{ steps.check.outputs.commits-behind }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Determine branches
        id: branches
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "source=${{ github.event.inputs.source_branch }}" >> $GITHUB_OUTPUT
            echo "target=${{ github.event.inputs.target_branch }}" >> $GITHUB_OUTPUT
          else
            # å®šæ—¶ä»»åŠ¡é»˜è®¤ä» master åŒæ­¥åˆ° develop
            echo "source=master" >> $GITHUB_OUTPUT
            echo "target=develop" >> $GITHUB_OUTPUT
          fi

      - name: Check sync status
        id: check
        run: |
          SOURCE_BRANCH="${{ steps.branches.outputs.source }}"
          TARGET_BRANCH="${{ steps.branches.outputs.target }}"
          
          git fetch origin $SOURCE_BRANCH:$SOURCE_BRANCH
          git fetch origin $TARGET_BRANCH:$TARGET_BRANCH
          
          # æ£€æŸ¥ç›®æ ‡åˆ†æ”¯æ˜¯å¦è½åäºæºåˆ†æ”¯
          COMMITS_BEHIND=$(git rev-list --count $TARGET_BRANCH..$SOURCE_BRANCH)
          echo "commits-behind=$COMMITS_BEHIND" >> $GITHUB_OUTPUT
          
          if [ "$COMMITS_BEHIND" -gt 0 ]; then
            echo "needs-sync=true" >> $GITHUB_OUTPUT
            echo "Target branch $TARGET_BRANCH is $COMMITS_BEHIND commits behind $SOURCE_BRANCH"
          else
            echo "needs-sync=false" >> $GITHUB_OUTPUT
            echo "Target branch $TARGET_BRANCH is up to date with $SOURCE_BRANCH"
          fi

  # æ‰§è¡ŒåŒæ­¥
  perform-sync:
    runs-on: ubuntu-latest
    needs: sync-check
    if: needs.sync-check.outputs.needs-sync == 'true'
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Attempt automatic sync
        id: auto-sync
        run: |
          SOURCE_BRANCH="${{ needs.sync-check.outputs.source-branch }}"
          TARGET_BRANCH="${{ needs.sync-check.outputs.target-branch }}"
          
          git checkout $TARGET_BRANCH
          git pull origin $TARGET_BRANCH
          
          # å°è¯•è‡ªåŠ¨åˆå¹¶
          if git merge origin/$SOURCE_BRANCH --no-edit; then
            echo "merge-success=true" >> $GITHUB_OUTPUT
            git push origin $TARGET_BRANCH
            echo "Automatic sync from $SOURCE_BRANCH to $TARGET_BRANCH completed successfully"
          else
            echo "merge-success=false" >> $GITHUB_OUTPUT
            git merge --abort
            echo "Automatic sync failed due to conflicts"
          fi

      - name: Create sync PR on conflict
        if: steps.auto-sync.outputs.merge-success == 'false' && github.event.inputs.force_sync != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const sourceBranch = '${{ needs.sync-check.outputs.source-branch }}';
            const targetBranch = '${{ needs.sync-check.outputs.target-branch }}';
            const commitsBehind = '${{ needs.sync-check.outputs.commits-behind }}';
            
            // åˆ›å»ºåŒæ­¥åˆ†æ”¯
            const syncBranchName = `sync/${sourceBranch}-to-${targetBranch}-${new Date().getTime()}`;
            
            await github.rest.git.createRef({
              owner,
              repo,
              ref: `refs/heads/${syncBranchName}`,
              sha: context.sha
            });
            
            // åˆ›å»º PR
            const pr = await github.rest.pulls.create({
              owner,
              repo,
              title: `ğŸ”„ Sync ${sourceBranch} to ${targetBranch}`,
              head: syncBranchName,
              base: targetBranch,
              body: `## ğŸ”„ åˆ†æ”¯åŒæ­¥è¯·æ±‚
            
              ### ğŸ“Š åŒæ­¥ä¿¡æ¯
              - **æºåˆ†æ”¯**: \`${sourceBranch}\`
              - **ç›®æ ‡åˆ†æ”¯**: \`${targetBranch}\`
              - **è½åæäº¤æ•°**: ${commitsBehind}
            
              ### âš ï¸ åˆå¹¶å†²çª
              è‡ªåŠ¨åŒæ­¥è¿‡ç¨‹ä¸­æ£€æµ‹åˆ°åˆå¹¶å†²çªï¼Œéœ€è¦æ‰‹åŠ¨è§£å†³ã€‚
            
              ### ğŸ“‹ æ“ä½œæ­¥éª¤
              1. æ£€å‡ºæ­¤åˆ†æ”¯åˆ°æœ¬åœ°
              2. è§£å†³æ‰€æœ‰åˆå¹¶å†²çª
              3. æäº¤è§£å†³æ–¹æ¡ˆ
              4. åˆå¹¶æ­¤ PR
            
              ### ğŸ¤– è‡ªåŠ¨ç”Ÿæˆ
              æ­¤ PR ç”±åˆ†æ”¯åŒæ­¥å·¥ä½œæµè‡ªåŠ¨åˆ›å»ºã€‚å¦‚éœ€å¼ºåˆ¶åŒæ­¥ï¼Œè¯·ä½¿ç”¨ \`force_sync\` é€‰é¡¹é‡æ–°è¿è¡Œå·¥ä½œæµã€‚`,
              draft: false
            });
            
            // æ·»åŠ æ ‡ç­¾
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pr.data.number,
              labels: ['sync', 'conflict-resolution', 'automated']
            });

      - name: Force sync with conflicts
        if: steps.auto-sync.outputs.merge-success == 'false' && github.event.inputs.force_sync == 'true'
        run: |
          SOURCE_BRANCH="${{ needs.sync-check.outputs.source-branch }}"
          TARGET_BRANCH="${{ needs.sync-check.outputs.target-branch }}"
          
          echo "Force syncing $SOURCE_BRANCH to $TARGET_BRANCH (this may overwrite conflicting changes)"
          
          git checkout $TARGET_BRANCH
          git reset --hard origin/$SOURCE_BRANCH
          git push --force-with-lease origin $TARGET_BRANCH
          
          echo "Force sync completed"

  # åŒæ­¥åéªŒè¯
  post-sync-validation:
    runs-on: ubuntu-latest
    needs: [ sync-check, perform-sync ]
    if: needs.perform-sync.result == 'success'
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Validate project structure
        run: |
          mvn validate
          echo "Project structure validation passed"

      - name: Quick compile test
        run: |
          mvn clean compile -q
          echo "Compilation test passed"

  # é€šçŸ¥å’Œæ‘˜è¦
  sync-summary:
    runs-on: ubuntu-latest
    needs: [ sync-check, perform-sync, post-sync-validation ]
    if: always()

    steps:
      - name: Generate sync summary
        run: |
          echo "## ğŸ”„ åˆ†æ”¯åŒæ­¥æ‰§è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š åŒæ­¥ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **æºåˆ†æ”¯**: ${{ needs.sync-check.outputs.source-branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç›®æ ‡åˆ†æ”¯**: ${{ needs.sync-check.outputs.target-branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.sync-check.outputs.needs-sync }}" = "true" ]; then
            echo "### ğŸ“‹ åŒæ­¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
            echo "- **è½åæäº¤æ•°**: ${{ needs.sync-check.outputs.commits-behind }}" >> $GITHUB_STEP_SUMMARY
            echo "- **åŒæ­¥çŠ¶æ€**: ${{ needs.perform-sync.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- **éªŒè¯çŠ¶æ€**: ${{ needs.post-sync-validation.result }}" >> $GITHUB_STEP_SUMMARY
          
            if [ "${{ needs.perform-sync.result }}" = "success" ]; then
              echo "- âœ… åŒæ­¥æˆåŠŸå®Œæˆ" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.perform-sync.result }}" = "failure" ]; then
              echo "- âŒ åŒæ­¥å¤±è´¥ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨è§£å†³å†²çª" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âœ… æ— éœ€åŒæ­¥" >> $GITHUB_STEP_SUMMARY
            echo "ç›®æ ‡åˆ†æ”¯å·²ä¸æºåˆ†æ”¯ä¿æŒåŒæ­¥ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create issue on sync failure
        if: needs.perform-sync.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            
            await github.rest.issues.create({
              owner,
              repo,
              title: `ğŸš¨ åˆ†æ”¯åŒæ­¥å¤±è´¥ - ${{ needs.sync-check.outputs.source-branch }} to ${{ needs.sync-check.outputs.target-branch }}`,
              body: `## ğŸš¨ åˆ†æ”¯åŒæ­¥å¤±è´¥æŠ¥å‘Š
            
              ### ğŸ“Š å¤±è´¥ä¿¡æ¯
              - **æºåˆ†æ”¯**: \`${{ needs.sync-check.outputs.source-branch }}\`
              - **ç›®æ ‡åˆ†æ”¯**: \`${{ needs.sync-check.outputs.target-branch }}\`
              - **è½åæäº¤æ•°**: ${{ needs.sync-check.outputs.commits-behind }}
              - **å¤±è´¥æ—¶é—´**: ${new Date().toISOString()}
            
              ### ğŸ“‹ å¯èƒ½åŸå› 
              - åˆå¹¶å†²çª
              - æƒé™é—®é¢˜
              - ç½‘ç»œé—®é¢˜
            
              ### ğŸ”§ å»ºè®®è§£å†³æ–¹æ¡ˆ
              1. æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—äº†è§£å…·ä½“é”™è¯¯
              2. æ‰‹åŠ¨æ‰§è¡Œåˆ†æ”¯åˆå¹¶
              3. å¦‚éœ€è¦ï¼Œä½¿ç”¨ \`force_sync\` é€‰é¡¹é‡æ–°è¿è¡ŒåŒæ­¥
              4. æ£€æŸ¥åˆ†æ”¯ä¿æŠ¤è§„åˆ™è®¾ç½®
            
              ### ğŸ¤– è‡ªåŠ¨ç”Ÿæˆ
              æ­¤é—®é¢˜ç”±åˆ†æ”¯åŒæ­¥å·¥ä½œæµè‡ªåŠ¨åˆ›å»ºã€‚è§£å†³é—®é¢˜åè¯·å…³é—­æ­¤ issueã€‚`,
              labels: ['bug', 'sync-failure', 'automated', 'priority-high']
            });
